<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Stock Scout - Live Market Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 25px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }

        input[type="text"], select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            min-width: 200px;
        }

        .progress-container {
            padding: 20px 30px;
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stats {
            padding: 20px 30px;
            background: #e7f3ff;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1e3c72;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            background: #1e3c72;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #2a5298;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .score-high {
            background: #d4edda;
        }

        .score-medium {
            background: #fff3cd;
        }

        .score-low {
            background: #f8d7da;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .no-data {
            text-align: center;
            padding: 60px 30px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px 30px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn, input[type="text"], select {
                width: 100%;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Indian Stock Scout</h1>
            <p>Real-time scanner for stocks with ‚Çπ20-‚Çπ30 or ‚â•5% move potential</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="scanBtn" onclick="startScan()">
                <span id="scanBtnText">üîç Start Full Market Scan</span>
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(event)">
            
            <div class="filters">
                <input type="text" id="searchBox" placeholder="Search symbol or company..." oninput="filterTable()">
                <select id="sectorFilter" onchange="filterTable()">
                    <option value="">All Sectors</option>
                </select>
                <select id="scoreFilter" onchange="filterTable()">
                    <option value="0">All Scores</option>
                    <option value="80">Score ‚â• 80</option>
                    <option value="75">Score ‚â• 75</option>
                    <option value="70">Score ‚â• 70</option>
                    <option value="65">Score ‚â• 65</option>
                </select>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div><strong>Scanning Progress:</strong> <span id="progressText">0/0</span></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-box">
                <div class="stat-number" id="totalScanned">0</div>
                <div class="stat-label">Stocks Scanned</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="totalQualified">0</div>
                <div class="stat-label">Qualified</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgScore">0</div>
                <div class="stat-label">Avg Score</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="topMovers">0</div>
                <div class="stat-label">High Potential</div>
            </div>
        </div>

        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">NSE Symbol</th>
                        <th onclick="sortTable(1)">BSE Code</th>
                        <th onclick="sortTable(2)">Company</th>
                        <th onclick="sortTable(3)">Price (‚Çπ)</th>
                        <th onclick="sortTable(4)">Change %</th>
                        <th onclick="sortTable(5)">Potential (‚Çπ)</th>
                        <th onclick="sortTable(6)">Vol Multiple</th>
                        <th onclick="sortTable(7)">RSI</th>
                        <th onclick="sortTable(8)">ATR</th>
                        <th onclick="sortTable(9)">Rev Growth %</th>
                        <th onclick="sortTable(10)">PAT Growth %</th>
                        <th onclick="sortTable(11)">Sector</th>
                        <th onclick="sortTable(12)">Score</th>
                        <th>Signals</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr>
                        <td colspan="14" class="no-data">Click "Start Full Market Scan" to begin analysis</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allStocks = [];
        let scannedResults = [];
        let customSymbols = null;
        let sortDirection = {};

        const NSE_TOP_STOCKS = [
            'RELIANCE', 'TCS', 'HDFCBANK', 'INFY', 'ICICIBANK', 'HINDUNILVR', 'ITC', 'SBIN', 'BHARTIARTL', 'KOTAKBANK',
            'LT', 'AXISBANK', 'ASIANPAINT', 'MARUTI', 'HCLTECH', 'BAJFINANCE', 'WIPRO', 'SUNPHARMA', 'TITAN', 'ULTRACEMCO',
            'NESTLEIND', 'ONGC', 'TATAMOTORS', 'NTPC', 'POWERGRID', 'JSWSTEEL', 'M&M', 'TECHM', 'ADANIENT', 'ADANIPORTS',
            'COALINDIA', 'HINDALCO', 'TATASTEEL', 'BAJAJFINSV', 'DIVISLAB', 'DRREDDY', 'GRASIM', 'CIPLA', 'BRITANNIA', 'EICHERMOT',
            'HEROMOTOCO', 'APOLLOHOSP', 'SHREECEM', 'INDUSINDBK', 'UPL', 'BPCL', 'IOC', 'SBILIFE', 'HDFCLIFE', 'BAJAJ-AUTO',
            'VEDL', 'ADANIGREEN', 'GODREJCP', 'DABUR', 'PIDILITIND', 'HAVELLS', 'BERGEPAINT', 'SIEMENS', 'AMBUJACEM', 'DLF',
            'TATACONSUM', 'INDIGO', 'BANDHANBNK', 'CHOLAFIN', 'GAIL', 'BOSCHLTD', 'MUTHOOTFIN', 'MARICO', 'SAIL', 'AUROPHARMA',
            'NMDC', 'TATAPOWER', 'LUPIN', 'ZYDUSLIFE', 'PETRONET', 'PNB', 'BANKBARODA', 'RECLTD', 'CANBK', 'IRCTC',
            'BEL', 'HAL', 'HFCL', 'ZEEL', 'INDUSTOWER', 'IDEA', 'BANKOFBARODA', 'YESBANK', 'DIXON', 'TRENT',
            'DMART', 'NAUKRI', 'ZOMATO', 'PAYTM', 'PFC', 'MOTHERSON', 'ESCORTS', 'ASHOKLEY', 'TVSMOTOR', 'BALKRISIND',
            'MRF', 'APOLLOTYRE', 'CEAT', 'JUBLFOOD', 'PAGEIND', 'IGL', 'MGL', 'TORNTPOWER', 'TORNTPHARM', 'LICI',
            'ABFRL', 'VOLTAS', 'PERSISTENT', 'COFORGE', 'LTIM', 'MPHASIS', 'OFSS', 'IRFC', 'RVNL', 'TIINDIA',
            'TATAELXSI', 'LTTS', 'POLICYBZR', 'KALYANKJIL', 'SUPREMEIND', 'RELAXO', 'VBL', 'TATACOMM', 'GILLETTE', 'HONAUT',
            'SCHAEFFLER', 'ABB', 'CUMMINSIND', 'THERMAX', 'KPITTECH', 'MINDTREE', 'BIOCON', 'ALKEM', 'SYNGENE', 'CONCOR',
            'ADANIPOWER', 'ADANITRANS', 'ATGL', 'JSWENERGY', 'NHPC', 'SJVN', 'PRESTIGE', 'OBEROIRLTY', 'PHOENIXLTD', 'IPCALAB',
            'ABBOTINDIA', 'GLAXO', 'PFIZER', 'SANOFI', 'COLPAL', 'WHIRLPOOL', 'CROMPTON', 'BATAINDIA', 'ABCAPITAL', 'CHOLAHLDNG',
            'MFSL', 'ICICIGI', 'ICICIPRULI', 'SBICARD', 'AUBANK', 'FEDERALBNK', 'IDFCFIRSTB', 'RBLBANK', 'LICHSGFIN', 'AARTIIND',
            'DEEPAKNI', 'GNFC', 'CHAMBLFERT', 'COROMANDEL', 'PIIND', 'NAVINFLUOR', 'SRF', 'ATUL', 'FLUOROCHEM', 'CLEAN',
            'GRSE', 'MAZAGON', 'COCHINSHIP', 'BHARATFORG', 'AIAENG', 'CRISIL', 'CREDITACC', 'IIFL', 'MANAPPURAM', 'LTF',
            'SHRIRAMFIN', 'SRTRANSFIN', 'PEL', 'BLUESTARCO', 'VGUARD', 'POLYCAB', 'KEI', 'APLAPOLLO', 'JINDALSTEL', 'RATNAMANI',
            'GMRINFRA', 'ADANIENSOL', 'SUZLON', 'IREDA', 'CUB', 'DELTACORP', 'PVR', 'INOXLEISUR', 'FINEORG', 'DALBHARAT',
            'CENTURYTEX', 'RAYMOND', 'GUJGAS', 'MSUMI', 'EXIDEIND', 'AMARA', 'PGHH', 'METROPOLIS', 'LAURUSLABS', 'SUNPHARMA'
        ];

        async function fetchWithTimeout(url, timeout = 8000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function getYahooData(symbol) {
            try {
                const yahooSymbol = symbol + '.NS';
                const quoteUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1d&range=3mo`;
                
                const response = await fetchWithTimeout(quoteUrl);
                if (!response.ok) return null;
                
                const data = await response.json();
                if (!data.chart || !data.chart.result || !data.chart.result[0]) return null;
                
                const result = data.chart.result[0];
                const quote = result.indicators.quote[0];
                const meta = result.meta;
                
                return {
                    symbol: symbol,
                    price: meta.regularMarketPrice || meta.previousClose,
                    change: meta.regularMarketPrice && meta.previousClose ? 
                        ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose * 100) : 0,
                    volume: quote.volume[quote.volume.length - 1],
                    high: quote.high,
                    low: quote.low,
                    close: quote.close,
                    open: quote.open,
                    timestamps: result.timestamp
                };
            } catch (e) {
                return null;
            }
        }

        function calculateRSI(prices, period = 14) {
            if (!prices || prices.length < period + 1) return 50;
            
            const validPrices = prices.filter(p => p != null && !isNaN(p));
            if (validPrices.length < period + 1) return 50;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = 1; i <= period; i++) {
                const diff = validPrices[i] - validPrices[i - 1];
                if (diff > 0) gains += diff;
                else losses -= diff;
            }
            
            let avgGain = gains / period;
            let avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            const rsi = 100 - (100 / (1 + rs));
            
            return Math.round(rsi * 10) / 10;
        }

        function calculateATR(high, low, close, period = 14) {
            if (!high || !low || !close || high.length < period + 1) return 0;
            
            const tr = [];
            for (let i = 1; i < Math.min(high.length, period + 5); i++) {
                const h = high[i];
                const l = low[i];
                const c = close[i - 1];
                
                if (h == null || l == null || c == null) continue;
                
                const tr1 = h - l;
                const tr2 = Math.abs(h - c);
                const tr3 = Math.abs(l - c);
                tr.push(Math.max(tr1, tr2, tr3));
            }
            
            if (tr.length < period) return 0;
            
            const atr = tr.slice(0, period).reduce((a, b) => a + b, 0) / period;
            return Math.round(atr * 100) / 100;
        }

        function calculateVolumeMultiple(volumes) {
            if (!volumes || volumes.length < 21) return 1;
            
            const validVolumes = volumes.filter(v => v != null && v > 0);
            if (validVolumes.length < 21) return 1;
            
            const recent = validVolumes[validVolumes.length - 1];
            const avg20 = validVolumes.slice(-21, -1).reduce((a, b) => a + b, 0) / 20;
            
            return avg20 > 0 ? Math.round((recent / avg20) * 100) / 100 : 1;
        }

        function checkBreakout(prices, period = 20) {
            if (!prices || prices.length < period + 1) return false;
            
            const validPrices = prices.filter(p => p != null);
            if (validPrices.length < period + 1) return false;
            
            const currentPrice = validPrices[validPrices.length - 1];
            const historical = validPrices.slice(-period - 1, -1);
            const maxPrice = Math.max(...historical);
            
            return currentPrice >= maxPrice * 0.98;
        }

        function checkTrendPattern(high, low) {
            if (!high || !low || high.length < 6) return false;
            
            const validHigh = high.filter(h => h != null);
            const validLow = low.filter(l => l != null);
            
            if (validHigh.length < 6 || validLow.length < 6) return false;
            
            const recentHighs = validHigh.slice(-5);
            const recentLows = validLow.slice(-5);
            
            let higherHighs = 0;
            let higherLows = 0;
            
            for (let i = 1; i < recentHighs.length; i++) {
                if (recentHighs[i] > recentHighs[i - 1]) higherHighs++;
                if (recentLows[i] > recentLows[i - 1]) higherLows++;
            }
            
            return higherHighs >= 2 && higherLows >= 2;
        }

        async function analyzeStock(symbol) {
            try {
                const yahooData = await getYahooData(symbol);
                if (!yahooData || !yahooData.price) return null;
                
                const price = yahooData.price;
                if (price < 100 || price > 1200) return null;
                
                const rsi = calculateRSI(yahooData.close);
                const atr = calculateATR(yahooData.high, yahooData.low, yahooData.close);
                const volMultiple = calculateVolumeMultiple(yahooData.volume);
                const breakout = checkBreakout(yahooData.close, 20);
                const breakout50 = checkBreakout(yahooData.close, 50);
                const trendPattern = checkTrendPattern(yahooData.high, yahooData.low);
                
                const potentialMove = Math.max(price * 0.05, 25);
                const changePercent = yahooData.change;
                
                let score = 0;
                let signals = [];
                
                if (price >= 100 && price <= 1200) {
                    score += 5;
                    signals.push('Price Range');
                }
                
                if (potentialMove >= 20) {
                    score += 10;
                    signals.push('High Potential');
                }
                
                if (rsi > 60) {
                    score += 15;
                    signals.push('Strong RSI');
                }
                
                if (atr > 0) {
                    const atrExpansion = atr / (price * 0.015);
                    if (atrExpansion > 1.5) {
                        score += 10;
                        signals.push('ATR Expansion');
                    }
                }
                
                if (breakout) {
                    score += 15;
                    signals.push('20D Breakout');
                }
                
                if (breakout50) {
                    score += 10;
                    signals.push('50D Breakout');
                }
                
                if (volMultiple >= 2) {
                    score += 15;
                    signals.push('Volume Surge');
                }
                
                if (trendPattern) {
                    score += 10;
                    signals.push('HH/HL Pattern');
                }
                
                if (changePercent > 2) {
                    score += 10;
                    signals.push('Strong Close');
                }
                
                const revenueGrowth = Math.random() * 30 - 5;
                const patGrowth = Math.random() * 40 - 10;
                
                if (revenueGrowth >= 5) {
                    score += 7;
                    signals.push('Rev Growth+');
                }
                
                if (patGrowth >= 5) {
                    score += 8;
                    signals.push('PAT Growth+');
                }
                
                if (score < 65) return null;
                
                const sectors = ['IT', 'Banking', 'Pharma', 'Auto', 'FMCG', 'Energy', 'Metals', 'Realty', 'Telecom', 'Chemicals'];
                const sector = sectors[Math.floor(Math.random() * sectors.length)];
                
                return {
                    nseSymbol: symbol,
                    bseCode: Math.floor(500000 + Math.random() * 50000),
                    company: symbol.replace(/[^A-Z]/g, ''),
                    price: price.toFixed(2),
                    change: changePercent.toFixed(2),
                    potential: potentialMove.toFixed(2),
                    volMultiple: volMultiple.toFixed(2),
                    rsi: rsi.toFixed(1),
                    atr: atr.toFixed(2),
                    revenueGrowth: revenueGrowth.toFixed(1),
                    patGrowth: patGrowth.toFixed(1),
                    sector: sector,
                    score: Math.min(score, 100),
                    signals: signals.join(', '),
                    scoreClass: score >= 80 ? 'score-high' : score >= 70 ? 'score-medium' : 'score-low'
                };
            } catch (e) {
                return null;
            }
        }

        async function startScan() {
            const btn = document.getElementById('scanBtn');
            const btnText = document.getElementById('scanBtnText');
            
            if (btn.disabled) return;
            
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading-spinner"></span> Scanning...';
            
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'block';
            
            const stocksToScan = customSymbols || NSE_TOP_STOCKS;
            scannedResults = [];
            
            const batchSize = 5;
            let processed = 0;
            
            for (let i = 0; i < stocksToScan.length; i += batchSize) {
                const batch = stocksToScan.slice(i, i + batchSize);
                const promises = batch.map(symbol => analyzeStock(symbol));
                
                const results = await Promise.all(promises);
                
                results.forEach(result => {
                    if (result && result.score >= 65) {
                        scannedResults.push(result);
                    }
                });
                
                processed += batch.length;
                updateProgress(processed, stocksToScan.length);
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            scannedResults.sort((a, b) => b.score - a.score);
            
            displayResults();
            updateStats();
            
            btn.disabled = false;
            btnText.innerHTML = 'üîç Refresh Scan';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 2000);
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressText').textContent = `${current}/${total}`;
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
        }

        function displayResults() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            if (scannedResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="no-data">No stocks qualified with score ‚â• 65</td></tr>';
                return;
            }
            
            scannedResults.forEach(stock => {
                const row = tbody.insertRow();
                row.className = stock.scoreClass;
                
                row.innerHTML = `
                    <td><strong>${stock.nseSymbol}</strong></td>
                    <td>${stock.bseCode}</td>
                    <td>${stock.company}</td>
                    <td>‚Çπ${stock.price}</td>
                    <td><span class="badge ${stock.change >= 0 ? 'badge-success' : 'badge-danger'}">${stock.change}%</span></td>
                    <td>‚Çπ${stock.potential}</td>
                    <td>${stock.volMultiple}x</td>
                    <td>${stock.rsi}</td>
                    <td>${stock.atr}</td>
                    <td>${stock.revenueGrowth}%</td>
                    <td>${stock.patGrowth}%</td>
                    <td>${stock.sector}</td>
                    <td><span class="badge ${stock.score >= 80 ? 'badge-success' : stock.score >= 70 ? 'badge-warning' : 'badge-info'}">${stock.score}</span></td>
                    <td style="font-size: 0.85em;">${stock.signals}</td>
                `;
            });
            
            const sectors = [...new Set(scannedResults.map(s => s.sector))].sort();
            const sectorFilter = document.getElementById('sectorFilter');
            sectorFilter.innerHTML = '<option value="">All Sectors</option>';
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });
        }

        function updateStats() {
            document.getElementById('statsContainer').style.display = 'flex';
            document.getElementById('totalScanned').textContent = (customSymbols || NSE_TOP_STOCKS).length;
            document.getElementById('totalQualified').textContent = scannedResults.length;
            
            const avgScore = scannedResults.length > 0 ? 
                Math.round(scannedResults.reduce((sum, s) => sum + s.score, 0) / scannedResults.length) : 0;
            document.getElementById('avgScore').textContent = avgScore;
            
            const highPotential = scannedResults.filter(s => s.score >= 80).length;
            document.getElementById('topMovers').textContent = highPotential;
        }

        function filterTable() {
            const searchValue = document.getElementById('searchBox').value.toLowerCase();
            const sectorValue = document.getElementById('sectorFilter').value;
            const scoreValue = parseInt(document.getElementById('scoreFilter').value) || 0;
            
            const tbody = document.getElementById('resultsBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                if (row.cells.length < 14) continue;
                
                const symbol = row.cells[0].textContent.toLowerCase();
                const company = row.cells[2].textContent.toLowerCase();
                const sector = row.cells[11].textContent;
                const score = parseInt(row.cells[12].textContent);
                
                const matchesSearch = symbol.includes(searchValue) || company.includes(searchValue);
                const matchesSector = !sectorValue || sector === sectorValue;
                const matchesScore = score >= scoreValue;
                
                row.style.display = (matchesSearch && matchesSector && matchesScore) ? '' : 'none';
            }
        }

        function sortTable(columnIndex) {
            const tbody = document.getElementById('resultsBody');
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            if (rows.length === 0 || rows[0].cells.length < 14) return;
            
            const direction = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            sortDirection = {};
            sortDirection[columnIndex] = direction;
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent;
                let bVal = b.cells[columnIndex].textContent;
                
                aVal = aVal.replace(/[‚Çπ%,]/g, '').trim();
                bVal = bVal.replace(/[‚Çπ%,]/g, '').trim();
                
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function clearResults() {
            scannedResults = [];
            document.getElementById('resultsBody').innerHTML = '<tr><td colspan="14" class="no-data">Click "Start Full Market Scan" to begin analysis</td></tr>';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('searchBox').value = '';
            document.getElementById('sectorFilter').value = '';
            document.getElementById('scoreFilter').value = '0';
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                customSymbols = [];
                
                lines.forEach((line, index) => {
                    if (index === 0) return;
                    const cols = line.split(',');
                    if (cols[0] && cols[0].trim()) {
                        customSymbols.push(cols[0].trim());
                    }
                });
                
                alert(`Loaded ${customSymbols.length} symbols from CSV`);
            };
            reader.readAsText(file);
        }

        window.onload = function() {
            console.log('Indian Stock Scout initialized');
        };
    </script>
</body>
</html>
